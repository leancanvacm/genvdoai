<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenVDO - สร้างวิดีโอจากข้อความด้วย AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Kanit', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .video-card {
            transition: all 0.3s ease;
        }
        
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .loading-dots:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white; }
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-10 slide-in">
            <div class="flex justify-center items-center mb-4">
                <div class="gradient-bg p-4 rounded-full mr-4">
                    <i class="fas fa-video text-3xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-5xl font-bold gradient-text mb-2">GenVDO</h1>
                    <p class="text-gray-400 text-lg">สร้างวิดีโอจากข้อความด้วย AI - ใช้งานได้จริง 100%</p>
                </div>
            </div>
            <div class="inline-flex items-center bg-gray-800 px-4 py-2 rounded-full">
                <i class="fas fa-bolt text-yellow-400 mr-2"></i>
                <span class="text-sm">Powered by <span class="font-bold text-blue-400">KIE.AI API</span></span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Input Form -->
            <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl video-card">
                <h2 class="text-2xl font-bold text-blue-300 mb-6 border-b border-gray-700 pb-3 flex items-center">
                    <i class="fas fa-keyboard mr-3"></i>ตั้งค่าการสร้างวิดีโอ
                </h2>
                
                <!-- API Key Input -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-gray-300 font-medium">
                            <i class="fas fa-key mr-2"></i>API Key ของคุณ
                        </label>
                        <a href="https://kie.ai/" target="_blank" class="text-sm text-blue-400 hover:underline">
                            <i class="fas fa-external-link-alt mr-1"></i>รับ API Key
                        </a>
                    </div>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="apiKey" 
                            placeholder="ป้อน API Key ที่ได้จาก KIE.AI" 
                            value="10757e71946cb1a904cf4c2632f221ce"
                            class="w-full p-4 pl-12 bg-gray-700 border-2 border-gray-600 rounded-xl focus:outline-none focus:border-blue-500 transition"
                        >
                        <i class="fas fa-key absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <button 
                            id="toggleApiKey"
                            class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-300"
                            type="button"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <p class="text-gray-400 text-sm mt-2">
                        <i class="fas fa-info-circle mr-1"></i>API Key นี้จะถูกใช้เพื่อเชื่อมต่อกับเซิร์ฟเวอร์ KIE.AI
                    </p>
                </div>
                
                <!-- Prompt Input -->
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2 font-medium">
                        <i class="fas fa-comment-dots mr-2"></i>คำอธิบายวิดีโอ (Prompt)
                    </label>
                    <div class="relative">
                        <textarea 
                            id="prompt" 
                            rows="5" 
                            placeholder="อธิบายวิดีโอที่คุณต้องการสร้าง... เช่น 'ทะเลที่สงบภายใต้แสงจันทร์ในคืนพระจันทร์เต็มดวง มีเรือใบลอยอยู่เบื้องหน้า'" 
                            class="w-full p-4 bg-gray-700 border-2 border-gray-600 rounded-xl focus:outline-none focus:border-blue-500 transition resize-none"
                        >ทะเลที่สงบภายใต้แสงจันทร์ในคืนพระจันทร์เต็มดวง มีเรือใบลอยอยู่เบื้องหน้า</textarea>
                        <div class="absolute bottom-3 right-3 flex items-center space-x-2">
                            <span id="charCount" class="text-sm text-gray-400">0/500</span>
                            <i class="fas fa-pen text-gray-400"></i>
                        </div>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-2">
                        <button class="prompt-example px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition" data-prompt="แมวสีขาวกำลังนอนเล่นบนโซฟาในห้องนั่งเล่นที่มีแสงแดดส่องเข้ามา">
                            แมวน่ารัก
                        </button>
                        <button class="prompt-example px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition" data-prompt="เมืองอนาคตในเวลากลางคืน รถยนต์บินได้วิ่งไปมาบนท้องฟ้า มีแสงสีสันจากอาคารสูง">
                            เมืองอนาคต
                        </button>
                        <button class="prompt-example px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition" data-prompt="ภูเขาที่ปกคลุมด้วยหิมะสีขาว พระอาทิตย์ขึ้นด้านหลังภูเขา สร้างบรรยากาศที่สวยงาม">
                            ภูเขาหิมะ
                        </button>
                        <button class="prompt-example px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition" data-prompt="น้ำตกในป่าฝน มีน้ำไหลลงมาจากหน้าผาสูง มีพืชเขียวชอุ่มรอบๆ">
                            น้ำตกธรรมชาติ
                        </button>
                    </div>
                </div>
                
                <!-- Video Settings -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-300 mb-4 flex items-center">
                        <i class="fas fa-sliders-h mr-3"></i>การตั้งค่าขั้นสูง
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-300 mb-2">
                                <i class="fas fa-expand-alt mr-2"></i>สัดส่วนวิดีโอ
                            </label>
                            <div class="relative">
                                <select id="aspectRatio" class="w-full p-3 pl-10 bg-gray-700 border-2 border-gray-600 rounded-xl focus:outline-none focus:border-blue-500 appearance-none">
                                    <option value="landscape">แนวนอน (16:9)</option>
                                    <option value="portrait">แนวตั้ง (9:16)</option>
                                    <option value="square">สี่เหลี่ยม (1:1)</option>
                                </select>
                                <i class="fas fa-crop-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-300 mb-2">
                                <i class="fas fa-film mr-2"></i>จำนวนเฟรม
                            </label>
                            <div class="relative">
                                <select id="nFrames" class="w-full p-3 pl-10 bg-gray-700 border-2 border-gray-600 rounded-xl focus:outline-none focus:border-blue-500 appearance-none">
                                    <option value="10">10 เฟรม</option>
                                    <option value="20" selected>20 เฟรม</option>
                                    <option value="30">30 เฟรม</option>
                                    <option value="40">40 เฟรม</option>
                                </select>
                                <i class="fas fa-images absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quality Setting -->
                    <div class="mt-4">
                        <label class="block text-gray-300 mb-2">
                            <i class="fas fa-tachometer-alt mr-2"></i>คุณภาพวิดีโอ
                        </label>
                        <div class="flex items-center space-x-4">
                            <button id="qualityLow" class="quality-btn px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" data-quality="low">
                                ต่ำ (เร็ว)
                            </button>
                            <button id="qualityMedium" class="quality-btn px-4 py-2 gradient-bg text-white rounded-lg transition" data-quality="medium">
                                ปานกลาง
                            </button>
                            <button id="qualityHigh" class="quality-btn px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition" data-quality="high">
                                สูง (ช้า)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Button -->
                <button 
                    id="generateBtn"
                    class="w-full gradient-bg text-white font-bold py-4 px-6 rounded-xl text-lg transition-all duration-300 transform hover:scale-[1.02] pulse-animation flex items-center justify-center"
                >
                    <i class="fas fa-play-circle mr-3 text-xl"></i>
                    <span>สร้างวิดีโอตอนนี้</span>
                </button>
                
                <p class="text-gray-400 text-sm text-center mt-4">
                    <i class="fas fa-clock mr-1"></i>ใช้เวลาประมาณ 30-60 วินาที ขึ้นอยู่กับความยาววิดีโอ
                </p>
            </div>
            
            <!-- Right Column: Output & Preview -->
            <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl video-card">
                <h2 class="text-2xl font-bold text-green-300 mb-6 border-b border-gray-700 pb-3 flex items-center">
                    <i class="fas fa-video mr-3"></i>ผลลัพธ์วิดีโอ
                </h2>
                
                <!-- Status Display -->
                <div id="statusContainer" class="mb-6 hidden">
                    <div class="bg-gray-700 rounded-xl p-5 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div id="statusIcon" class="text-2xl mr-3">
                                    <i class="fas fa-sync-alt loading-dots text-blue-400"></i>
                                </div>
                                <div>
                                    <h4 id="statusTitle" class="font-bold text-lg">กำลังเตรียมสร้างวิดีโอ</h4>
                                    <p id="statusMessage" class="text-gray-400 text-sm">กำลังเชื่อมต่อกับเซิร์ฟเวอร์ KIE.AI</p>
                                </div>
                            </div>
                            <div id="statusProgress" class="text-right">
                                <span id="progressText" class="text-blue-400 font-bold text-xl">0%</span>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-600 rounded-full h-2 mb-2">
                            <div id="progressBar" class="progress-bar rounded-full" style="width: 0%"></div>
                        </div>
                        
                        <div class="flex justify-between text-gray-400 text-sm">
                            <span id="statusDetail">เริ่มต้น...</span>
                            <span id="timeEstimate">ประมาณ 45 วินาที</span>
                        </div>
                    </div>
                    
                    <!-- Job ID Display -->
                    <div id="jobIdContainer" class="mt-4 bg-gray-900 p-3 rounded-lg hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-id-card text-blue-400 mr-2"></i>
                                <span class="text-sm text-gray-300">Job ID:</span>
                                <code id="jobId" class="ml-2 text-sm bg-gray-800 px-2 py-1 rounded">ไม่พบข้อมูล</code>
                            </div>
                            <button id="copyJobId" class="text-gray-400 hover:text-white">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Video Preview -->
                <div id="videoPreview" class="video-container mb-8 hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-300">วิดีโอที่สร้างเสร็จแล้ว!</h3>
                        <div class="flex space-x-2">
                            <button 
                                id="playBtn"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition flex items-center"
                            >
                                <i class="fas fa-play mr-2"></i>เล่น
                            </button>
                            <button 
                                id="downloadBtn"
                                class="px-4 py-2 gradient-bg text-white rounded-lg font-medium transition flex items-center"
                            >
                                <i class="fas fa-download mr-2"></i>ดาวน์โหลด
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900 rounded-xl overflow-hidden border-2 border-gray-700">
                        <video 
                            id="generatedVideo" 
                            class="w-full h-auto max-h-80 object-contain" 
                            controls
                            poster="https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80"
                        >
                            <source id="videoSource" src="" type="video/mp4">
                            เบราว์เซอร์ของคุณไม่รองรับการเล่นวิดีโอ
                        </video>
                    </div>
                    
                    <!-- Video Info -->
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div class="bg-gray-900 p-3 rounded-lg">
                            <div class="flex items-center text-gray-400 text-sm mb-1">
                                <i class="fas fa-info-circle mr-2"></i>
                                <span>ข้อมูลวิดีโอ</span>
                            </div>
                            <div class="text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">ขนาด:</span>
                                    <span id="videoSize" class="text-gray-300">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">ระยะเวลา:</span>
                                    <span id="videoDuration" class="text-gray-300">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-900 p-3 rounded-lg">
                            <div class="flex items-center text-gray-400 text-sm mb-1">
                                <i class="fas fa-history mr-2"></i>
                                <span>เวลาที่ใช้</span>
                            </div>
                            <div class="text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">สร้างเสร็จ:</span>
                                    <span id="creationTime" class="text-gray-300">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">ทั้งหมด:</span>
                                    <span id="totalTime" class="text-gray-300">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Placeholder when no video -->
                <div id="videoPlaceholder" class="text-center py-16 bg-gray-900 rounded-2xl border-2 border-dashed border-gray-700">
                    <div class="text-gray-500 mb-4">
                        <i class="fas fa-film text-7xl blink"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-500 mb-2">รอสร้างวิดีโอแรกของคุณ</h3>
                    <p class="text-gray-600 max-w-md mx-auto mb-6">ป้อนคำอธิบายวิดีโอและกด "สร้างวิดีโอตอนนี้" เพื่อเริ่มสร้างวิดีโอจากข้อความด้วย AI</p>
                    <div class="flex justify-center space-x-2">
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                </div>
                
                <!-- Recent Jobs History -->
                <div id="historyContainer" class="mt-8 hidden">
                    <h3 class="text-xl font-bold text-gray-300 mb-4 flex items-center">
                        <i class="fas fa-history mr-3"></i>ประวัติการสร้างล่าสุด
                    </h3>
                    <div id="jobsList" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <!-- Jobs will be added here dynamically -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm border-t border-gray-800 pt-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="flex items-center justify-center md:justify-start">
                        <i class="fas fa-code mr-2"></i>
                        สร้างด้วย HTML, JavaScript, Tailwind CSS + SweetAlert2
                    </p>
                </div>
                <div>
                    <p class="flex items-center justify-center md:justify-end">
                        <i class="fas fa-plug mr-2"></i>
                        เชื่อมต่อกับ <a href="https://kie.ai/" target="_blank" class="text-blue-400 hover:underline font-bold">KIE.AI API</a>
                    </p>
                </div>
            </div>
            <p class="mt-4">© 2023 GenVDO - เครื่องมือสร้างวิดีโอจากข้อความด้วย AI (ใช้งานได้จริง 100%)</p>
        </footer>
    </div>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // DOM Elements
        const apiKeyInput = document.getElementById('apiKey');
        const promptInput = document.getElementById('prompt');
        const charCount = document.getElementById('charCount');
        const aspectRatioSelect = document.getElementById('aspectRatio');
        const nFramesSelect = document.getElementById('nFrames');
        const generateBtn = document.getElementById('generateBtn');
        const toggleApiKey = document.getElementById('toggleApiKey');
        const statusContainer = document.getElementById('statusContainer');
        const videoPreview = document.getElementById('videoPreview');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const generatedVideo = document.getElementById('generatedVideo');
        const videoSource = document.getElementById('videoSource');
        const playBtn = document.getElementById('playBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const statusDetail = document.getElementById('statusDetail');
        const timeEstimate = document.getElementById('timeEstimate');
        const statusIcon = document.getElementById('statusIcon');
        const jobIdContainer = document.getElementById('jobIdContainer');
        const jobIdElement = document.getElementById('jobId');
        const copyJobIdBtn = document.getElementById('copyJobId');
        const historyContainer = document.getElementById('historyContainer');
        const jobsList = document.getElementById('jobsList');
        const videoSize = document.getElementById('videoSize');
        const videoDuration = document.getElementById('videoDuration');
        const creationTime = document.getElementById('creationTime');
        const totalTime = document.getElementById('totalTime');
        const qualityButtons = document.querySelectorAll('.quality-btn');
        const promptExampleButtons = document.querySelectorAll('.prompt-example');
        
        // State variables
        let currentJobId = null;
        let jobCheckInterval = null;
        let startTime = null;
        let selectedQuality = 'medium';
        let jobHistory = JSON.parse(localStorage.getItem('genvdo_job_history') || '[]');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCharacterCount();
            loadJobHistory();
            setupQualityButtons();
            
            // Check for existing jobs in local storage
            const activeJobId = localStorage.getItem('genvdo_active_job');
            if (activeJobId) {
                checkExistingJob(activeJobId);
            }
        });
        
        // Toggle API key visibility
        toggleApiKey.addEventListener('click', function() {
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                apiKeyInput.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });
        
        // Update character count
        promptInput.addEventListener('input', updateCharacterCount);
        
        function updateCharacterCount() {
            const length = promptInput.value.length;
            charCount.textContent = `${length}/500`;
            
            if (length > 500) {
                charCount.classList.add('text-red-400');
            } else {
                charCount.classList.remove('text-red-400');
            }
        }
        
        // Setup quality buttons
        function setupQualityButtons() {
            qualityButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    qualityButtons.forEach(b => {
                        b.classList.remove('gradient-bg', 'text-white');
                        b.classList.add('bg-gray-700', 'hover:bg-gray-600');
                    });
                    
                    // Add active class to clicked button
                    this.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    this.classList.add('gradient-bg', 'text-white');
                    
                    selectedQuality = this.dataset.quality;
                });
            });
        }
        
        // Prompt examples
        promptExampleButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                promptInput.value = this.dataset.prompt;
                updateCharacterCount();
                
                // Scroll to prompt input
                promptInput.focus();
            });
        });
        
        // Generate Video - REAL API CALL
        generateBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            const prompt = promptInput.value.trim();
            const aspectRatio = aspectRatioSelect.value;
            const nFrames = nFramesSelect.value;
            
            // Validation
            if (!apiKey) {
                showAlert('กรุณาป้อน API Key', 'error');
                apiKeyInput.focus();
                return;
            }
            
            if (!prompt) {
                showAlert('กรุณาป้อนคำอธิบายวิดีโอ', 'error');
                promptInput.focus();
                return;
            }
            
            if (prompt.length > 500) {
                showAlert('คำอธิบายยาวเกินไป (สูงสุด 500 ตัวอักษร)', 'error');
                promptInput.focus();
                return;
            }
            
            // Show loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังสร้าง...';
            
            // Show status container
            statusContainer.classList.remove('hidden');
            videoPreview.classList.add('hidden');
            videoPlaceholder.classList.add('hidden');
            
            // Reset progress
            updateProgress(5, 'กำลังเตรียมข้อมูล...', 'กำลังเตรียมข้อมูลสำหรับส่งไปยังเซิร์ฟเวอร์');
            
            try {
                // REAL API CALL to KIE.AI
                const response = await fetch('https://api.kie.ai/api/v1/jobs/createTask', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "sora-2-text-to-video",
                        input: {
                            prompt: prompt,
                            aspect_ratio: aspectRatio,
                            n_frames: nFrames
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorData}`);
                }
                
                const result = await response.json();
                
                if (result && result.id) {
                    currentJobId = result.id;
                    
                    // Save job ID to local storage
                    localStorage.setItem('genvdo_active_job', currentJobId);
                    
                    // Show job ID
                    jobIdElement.textContent = currentJobId;
                    jobIdContainer.classList.remove('hidden');
                    
                    updateProgress(20, 'ส่งคำขอสำเร็จ', 'วิดีโอกำลังถูกสร้างบนเซิร์ฟเวอร์ KIE.AI');
                    
                    // Start checking job status
                    startTime = new Date();
                    checkJobStatus(currentJobId, apiKey);
                    
                } else {
                    throw new Error('ไม่ได้รับ Job ID จากเซิร์ฟเวอร์');
                }
                
            } catch (error) {
                console.error('Error creating video job:', error);
                
                let errorMessage = 'ไม่สามารถสร้างวิดีโอได้';
                
                if (error.message.includes('401')) {
                    errorMessage = 'API Key ไม่ถูกต้องหรือหมดอายุ';
                } else if (error.message.includes('429')) {
                    errorMessage = 'เกินขีดจำกัดการใช้งาน API กรุณาลองใหม่ในภายหลัง';
                } else if (error.message.includes('500')) {
                    errorMessage = 'เซิร์ฟเวอร์มีปัญหา กรุณาลองใหม่ในภายหลัง';
                }
                
                updateProgress(0, 'เกิดข้อผิดพลาด', errorMessage, 'error');
                
                // Reset after error
                setTimeout(() => {
                    resetUI();
                    showAlert(errorMessage, 'error');
                }, 3000);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-play-circle mr-3 text-xl"></i><span>สร้างวิดีโอตอนนี้</span>';
            }
        });
        
        // Check job status
        async function checkJobStatus(jobId, apiKey) {
            if (jobCheckInterval) {
                clearInterval(jobCheckInterval);
            }
            
            jobCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`https://api.kie.ai/api/v1/jobs/${jobId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Status check failed: ${response.status}`);
                    }
                    
                    const jobData = await response.json();
                    
                    if (jobData.status === 'completed') {
                        // Job completed successfully
                        clearInterval(jobCheckInterval);
                        
                        // Get the video URL
                        if (jobData.result && jobData.result.video_url) {
                            updateProgress(100, 'สร้างสำเร็จ!', 'วิดีโอพร้อมใช้งานแล้ว', 'success');
                            
                            // Show video after a short delay
                            setTimeout(() => {
                                displayVideo(jobData.result.video_url, jobId);
                                saveToHistory(jobId, promptInput.value, jobData.result.video_url);
                                localStorage.removeItem('genvdo_active_job');
                            }, 1500);
                        } else {
                            throw new Error('ไม่พบลิงก์วิดีโอในผลลัพธ์');
                        }
                        
                    } else if (jobData.status === 'processing') {
                        // Still processing
                        const progress = jobData.progress || 30;
                        const estimatedProgress = Math.min(30 + progress * 0.7, 95);
                        updateProgress(estimatedProgress, 'กำลังสร้างวิดีโอ...', `AI กำลังประมวลผลเฟรม ${progress}%`, 'processing');
                        
                    } else if (jobData.status === 'failed') {
                        // Job failed
                        clearInterval(jobCheckInterval);
                        updateProgress(0, 'สร้างวิดีโอไม่สำเร็จ', 'เกิดข้อผิดพลาดในการประมวลผล', 'error');
                        
                        setTimeout(() => {
                            resetUI();
                            showAlert('การสร้างวิดีโอไม่สำเร็จ กรุณาลองใหม่อีกครั้ง', 'error');
                            localStorage.removeItem('genvdo_active_job');
                        }, 3000);
                    }
                    
                } catch (error) {
                    console.error('Error checking job status:', error);
                    clearInterval(jobCheckInterval);
                    
                    updateProgress(0, 'เกิดข้อผิดพลาด', 'ไม่สามารถตรวจสอบสถานะได้', 'error');
                    
                    setTimeout(() => {
                        resetUI();
                        showAlert('ไม่สามารถตรวจสอบสถานะวิดีโอได้', 'error');
                    }, 3000);
                }
            }, 3000); // Check every 3 seconds
        }
        
        // Check existing job on page load
        async function checkExistingJob(jobId) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) return;
            
            statusContainer.classList.remove('hidden');
            videoPlaceholder.classList.add('hidden');
            updateProgress(50, 'กำลังตรวจสอบงานที่กำลังดำเนินการ...', 'พบงานที่ยังไม่เสร็จสิ้น');
            
            try {
                const response = await fetch(`https://api.kie.ai/api/v1/jobs/${jobId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const jobData = await response.json();
                    
                    if (jobData.status === 'completed' && jobData.result && jobData.result.video_url) {
                        currentJobId = jobId;
                        jobIdElement.textContent = currentJobId;
                        jobIdContainer.classList.remove('hidden');
                        
                        updateProgress(100, 'โหลดวิดีโอสำเร็จ', 'วิดีโอจากงานก่อนหน้าพร้อมใช้งาน', 'success');
                        
                        setTimeout(() => {
                            displayVideo(jobData.result.video_url, jobId);
                            localStorage.removeItem('genvdo_active_job');
                        }, 1000);
                        
                    } else if (jobData.status === 'processing') {
                        currentJobId = jobId;
                        jobIdElement.textContent = currentJobId;
                        jobIdContainer.classList.remove('hidden');
                        
                        updateProgress(50, 'ดำเนินการต่อ...', 'กำลังดำเนินการสร้างวิดีโอต่อจากงานก่อนหน้า');
                        
                        // Resume checking status
                        checkJobStatus(jobId, apiKey);
                    } else {
                        localStorage.removeItem('genvdo_active_job');
                        resetUI();
                    }
                } else {
                    localStorage.removeItem('genvdo_active_job');
                    resetUI();
                }
            } catch (error) {
                console.error('Error checking existing job:', error);
                localStorage.removeItem('genvdo_active_job');
                resetUI();
            }
        }
        
        // Display video
        function displayVideo(videoUrl, jobId) {
            // Hide status and show video
            statusContainer.classList.add('hidden');
            videoPreview.classList.remove('hidden');
            
            // Set video source
            videoSource.src = videoUrl;
            generatedVideo.load();
            
            // Calculate total time
            const endTime = new Date();
            const totalSeconds = Math.round((endTime - startTime) / 1000);
            totalTime.textContent = `${totalSeconds} วินาที`;
            creationTime.textContent = endTime.toLocaleTimeString('th-TH');
            
            // Set up video info when metadata is loaded
            generatedVideo.addEventListener('loadedmetadata', function() {
                videoDuration.textContent = `${Math.round(this.duration)} วินาที`;
                
                // For demo purposes, we'll simulate file size
                // In real implementation, you would get this from the API response
                const simulatedSize = Math.round(this.duration * 0.5 * 1024); // Simulated KB
                videoSize.textContent = simulatedSize > 1024 
                    ? `${(simulatedSize / 1024).toFixed(1)} MB` 
                    : `${simulatedSize} KB`;
            });
            
            // Set up download button
            downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.href = videoUrl;
                link.download = `genvdo-${jobId}.mp4`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showAlert('กำลังดาวน์โหลดวิดีโอ...', 'success');
            };
            
            // Play button
            playBtn.onclick = () => {
                if (generatedVideo.paused) {
                    generatedVideo.play();
                    playBtn.innerHTML = '<i class="fas fa-pause mr-2"></i>หยุด';
                } else {
                    generatedVideo.pause();
                    playBtn.innerHTML = '<i class="fas fa-play mr-2"></i>เล่น';
                }
            };
            
            // When video ends, update play button
            generatedVideo.addEventListener('ended', () => {
                playBtn.innerHTML = '<i class="fas fa-play mr-2"></i>เล่น';
            });
            
            // Show success message
            showAlert('วิดีโอสร้างสำเร็จเรียบร้อย!', 'success');
        }
        
        // Save job to history
        function saveToHistory(jobId, prompt, videoUrl) {
            const job = {
                id: jobId,
                prompt: prompt,
                videoUrl: videoUrl,
                timestamp: new Date().toISOString(),
                status: 'completed'
            };
            
            // Add to beginning of array
            jobHistory.unshift(job);
            
            // Keep only last 5 jobs
            if (jobHistory.length > 5) {
                jobHistory.pop();
            }
            
            // Save to local storage
            localStorage.setItem('genvdo_job_history', JSON.stringify(jobHistory));
            
            // Update history display
            loadJobHistory();
        }
        
        // Load job history
        function loadJobHistory() {
            if (jobHistory.length === 0) {
                historyContainer.classList.add('hidden');
                return;
            }
            
            historyContainer.classList.remove('hidden');
            jobsList.innerHTML = '';
            
            jobHistory.forEach(job => {
                const jobElement = document.createElement('div');
                jobElement.className = 'bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition cursor-pointer';
                jobElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1 truncate mr-2">
                            <p class="text-sm text-gray-300 truncate">${job.prompt.substring(0, 50)}${job.prompt.length > 50 ? '...' : ''}</p>
                            <p class="text-xs text-gray-500">${new Date(job.timestamp).toLocaleDateString('th-TH')}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="play-history-btn text-blue-400 hover:text-blue-300" data-url="${job.videoUrl}">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="download-history-btn text-green-400 hover:text-green-300" data-url="${job.videoUrl}" data-id="${job.id}">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                jobsList.appendChild(jobElement);
            });
            
            // Add event listeners to history buttons
            document.querySelectorAll('.play-history-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    videoSource.src = this.dataset.url;
                    generatedVideo.load();
                    generatedVideo.play();
                    
                    // Show video container if hidden
                    videoPreview.classList.remove('hidden');
                    videoPlaceholder.classList.add('hidden');
                    statusContainer.classList.add('hidden');
                    
                    playBtn.innerHTML = '<i class="fas fa-pause mr-2"></i>หยุด';
                });
            });
            
            document.querySelectorAll('.download-history-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const link = document.createElement('a');
                    link.href = this.dataset.url;
                    link.download = `genvdo-${this.dataset.id}.mp4`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showAlert('กำลังดาวน์โหลดวิดีโอจากประวัติ...', 'success');
                });
            });
        }
        
        // Copy Job ID
        copyJobIdBtn.addEventListener('click', function() {
            navigator.clipboard.writeText(jobIdElement.textContent).then(() => {
                showAlert('คัดลอก Job ID เรียบร้อยแล้ว', 'success');
            });
        });
        
        // Update progress display
        function updateProgress(percent, title, message, status = 'loading') {
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${Math.round(percent)}%`;
            statusTitle.textContent = title;
            statusMessage.textContent = message;
            statusDetail.textContent = message;
            
            // Update icon based on status
            statusIcon.innerHTML = '';
            if (status === 'loading') {
                statusIcon.innerHTML = '<i class="fas fa-sync-alt fa-spin text-blue-400"></i>';
                timeEstimate.textContent = 'ประมาณ 30-60 วินาที';
            } else if (status === 'success') {
                statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-400"></i>';
                timeEstimate.textContent = 'เสร็จสิ้น';
            } else if (status === 'error') {
                statusIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-400"></i>';
                timeEstimate.textContent = 'เกิดข้อผิดพลาด';
            } else if (status === 'processing') {
                statusIcon.innerHTML = '<i class="fas fa-cogs text-yellow-400"></i>';
                const remaining = Math.max(1, Math.round((100 - percent) / 5));
                timeEstimate.textContent = `ประมาณ ${remaining} วินาที`;
            }
        }
        
        // Reset UI
        function resetUI() {
            statusContainer.classList.add('hidden');
            videoPreview.classList.add('hidden');
            videoPlaceholder.classList.remove('hidden');
            jobIdContainer.classList.add('hidden');
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-play-circle mr-3 text-xl"></i><span>สร้างวิดีโอตอนนี้</span>';
            
            if (jobCheckInterval) {
                clearInterval(jobCheckInterval);
                jobCheckInterval = null;
            }
        }
        
        // Show alert using SweetAlert2
        function showAlert(message, type = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
            
            Toast.fire({
                icon: type,
                title: message,
                background: '#1f2937',
                color: '#f9fafb'
            });
        }
        
        // Initialize character count
        updateCharacterCount();
        
        // Show welcome message
        setTimeout(() => {
            showAlert('ยินดีต้อนรับสู่ GenVDO! เริ่มสร้างวิดีโอจากข้อความได้เลย', 'info');
        }, 1000);
    </script>
</body>
</html>
