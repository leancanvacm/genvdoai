<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenVDO - สร้างวิดีโอจากข้อความด้วย Grok-Imagine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Kanit', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .glow {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .rotate {
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .bounce {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-12 slide-up">
            <div class="inline-block gradient-bg p-6 rounded-full mb-4 glow bounce">
                <i class="fas fa-robot text-4xl text-white"></i>
            </div>
            <h1 class="text-5xl font-bold gradient-text mb-3">GenVDO</h1>
            <p class="text-gray-400 text-lg mb-6">สร้างวิดีโอจากข้อความด้วย AI - แก้ไขปัญหา API แล้ว</p>
            
            <div class="flex flex-wrap justify-center gap-3 mb-8">
                <div class="bg-gray-800 px-4 py-2 rounded-full">
                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                    <span class="text-sm">API ทำงานปกติ</span>
                </div>
                <div class="bg-gray-800 px-4 py-2 rounded-full">
                    <i class="fas fa-bolt text-yellow-400 mr-2"></i>
                    <span class="text-sm">Grok-Imagine Model</span>
                </div>
                <div class="bg-gray-800 px-4 py-2 rounded-full">
                    <i class="fas fa-video text-blue-400 mr-2"></i>
                    <span class="text-sm">สร้างวิดีโอได้จริง</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left: Input Form -->
            <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-blue-300 mb-6 flex items-center">
                    <i class="fas fa-keyboard mr-3"></i>สร้างวิดีโอใหม่
                </h2>
                
                <!-- API Configuration -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-gray-300">API Settings</h3>
                        <div id="apiStatus" class="text-xs bg-green-900 text-green-300 px-3 py-1 rounded-full">
                            <i class="fas fa-check mr-1"></i>พร้อมใช้งาน
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-400 text-sm mb-2">API Key</label>
                            <div class="relative">
                                <input 
                                    type="password" 
                                    id="apiKey"
                                    value="10757e71946cb1a904cf4c2632f221ce"
                                    class="w-full p-4 pl-12 bg-gray-700 border-2 border-green-600 rounded-xl focus:outline-none focus:border-green-500"
                                >
                                <i class="fas fa-key absolute left-4 top-1/2 transform -translate-y-1/2 text-green-400"></i>
                                <button 
                                    id="toggleApiKey"
                                    class="absolute right-12 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-300"
                                >
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button 
                                    id="copyApiKey"
                                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-green-300"
                                >
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-400 text-sm mb-2">API Endpoint</label>
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="apiEndpoint"
                                    value="https://api.kie.ai/api/v1/jobs/createTask"
                                    class="w-full p-4 pl-12 bg-gray-700 border-2 border-blue-600 rounded-xl focus:outline-none"
                                    readonly
                                >
                                <i class="fas fa-server absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Video Creation Form -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-300 mb-4">Video Settings</h3>
                    
                    <!-- Prompt -->
                    <div class="mb-6">
                        <label class="block text-gray-300 mb-2">
                            <i class="fas fa-comment-dots mr-2"></i>คำอธิบายวิดีโอ
                        </label>
                        <textarea 
                            id="prompt"
                            rows="4"
                            placeholder="อธิบายวิดีโอที่คุณต้องการสร้าง..."
                            class="w-full p-4 bg-gray-700 border-2 border-gray-600 rounded-xl focus:outline-none focus:border-blue-500 resize-none"
                        >A beautiful sunset over mountains with clouds, cinematic style</textarea>
                        <div class="flex justify-between mt-2">
                            <span id="charCount" class="text-sm text-gray-400">0/500</span>
                            <button id="clearPrompt" class="text-sm text-gray-400 hover:text-gray-300">
                                <i class="fas fa-times mr-1"></i>ล้าง
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Prompts -->
                    <div class="mb-6">
                        <p class="text-gray-400 text-sm mb-2">ตัวอย่าง:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="prompt-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-left transition" data-prompt="A cat playing with yarn in a cozy living room with sunlight">
                                <div class="text-blue-300 text-sm font-medium">แมวน่ารัก</div>
                                <div class="text-gray-400 text-xs">เล่นกับไหมพรม</div>
                            </button>
                            <button class="prompt-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-left transition" data-prompt="Cyberpunk city at night with neon lights and flying cars">
                                <div class="text-blue-300 text-sm font-medium">เมืองอนาคต</div>
                                <div class="text-gray-400 text-xs">ไฟนีออนกลางคืน</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video Parameters -->
                    <div class="mb-8">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-400 text-sm mb-2">สัดส่วน</label>
                                <select id="aspectRatio" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option value="16:9">16:9 (วิดีโอ)</option>
                                    <option value="4:3">4:3 (มาตรฐาน)</option>
                                    <option value="1:1">1:1 (สี่เหลี่ยม)</option>
                                    <option value="2:3">2:3 (แนวตั้ง)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-400 text-sm mb-2">โหมด</label>
                                <select id="mode" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option value="normal" selected>ปกติ</option>
                                    <option value="fast">เร็ว</option>
                                    <option value="creative">สร้างสรรค์</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="space-y-4">
                    <button 
                        id="createVideoBtn"
                        class="w-full gradient-bg text-white font-bold py-4 px-6 rounded-xl text-lg hover:opacity-90 transition pulse-animation flex items-center justify-center"
                    >
                        <i class="fas fa-play-circle mr-3 text-xl"></i>
                        สร้างวิดีโอ
                    </button>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button 
                            id="testApiBtn"
                            class="bg-blue-800 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition flex items-center justify-center"
                        >
                            <i class="fas fa-vial mr-2"></i>
                            ทดสอบ API
                        </button>
                        <button 
                            id="simulateBtn"
                            class="bg-gray-700 hover:bg-gray-600 text-white py-3 px-4 rounded-lg transition flex items-center justify-center"
                        >
                            <i class="fas fa-magic mr-2"></i>
                            จำลองผลลัพธ์
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Right: Results -->
            <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-green-300 mb-6 flex items-center">
                    <i class="fas fa-video mr-3"></i>ผลลัพธ์
                </h2>
                
                <!-- Status Display -->
                <div id="statusContainer" class="mb-6 hidden">
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-5 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div id="statusIcon" class="text-2xl mr-3">
                                    <i class="fas fa-sync-alt rotate text-blue-400"></i>
                                </div>
                                <div>
                                    <h4 id="statusTitle" class="font-bold text-lg">กำลังสร้างวิดีโอ</h4>
                                    <p id="statusMessage" class="text-gray-400 text-sm">ส่งคำขอไปยังเซิร์ฟเวอร์</p>
                                </div>
                            </div>
                            <div id="statusProgress" class="text-right">
                                <span id="progressText" class="text-blue-400 font-bold text-xl">0%</span>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-3">
                            <div id="progressBar" class="progress-bar rounded-full" style="width: 0%"></div>
                        </div>
                        
                        <div class="flex justify-between text-gray-400 text-sm">
                            <span id="statusDetail">เตรียมข้อมูล...</span>
                            <span id="timeEstimate">ประมาณ 60 วินาที</span>
                        </div>
                    </div>
                    
                    <!-- Job Info -->
                    <div id="jobInfo" class="mt-4 bg-gray-900 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="text-gray-400">Job ID:</div>
                            <div class="text-gray-300 font-mono truncate" id="jobId">-</div>
                            <div class="text-gray-400">สถานะ:</div>
                            <div class="text-yellow-300" id="jobStatus">กำลังประมวลผล</div>
                            <div class="text-gray-400">โมเดล:</div>
                            <div class="text-green-300">grok-imagine/text-to-video</div>
                            <div class="text-gray-400">เริ่มเมื่อ:</div>
                            <div class="text-gray-300" id="startTime">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Video Result -->
                <div id="videoResult" class="mb-6 hidden fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-300">วิดีโอสร้างสำเร็จ!</h3>
                        <div class="flex space-x-2">
                            <button 
                                id="playBtn"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition flex items-center"
                            >
                                <i class="fas fa-play mr-2"></i>เล่น
                            </button>
                            <button 
                                id="downloadBtn"
                                class="px-4 py-2 gradient-bg text-white rounded-lg font-medium transition flex items-center"
                            >
                                <i class="fas fa-download mr-2"></i>ดาวน์โหลด
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video Player -->
                    <div class="bg-black rounded-xl overflow-hidden mb-6">
                        <video 
                            id="videoPlayer"
                            class="w-full h-auto max-h-80"
                            controls
                            poster=""
                        >
                            <source id="videoSource" src="" type="video/mp4">
                            เบราว์เซอร์ของคุณไม่รองรับแท็กวิดีโอ
                        </video>
                    </div>
                    
                    <!-- Video Stats -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-900 p-4 rounded-lg text-center">
                            <div class="text-gray-400 text-sm mb-1">เวลาที่ใช้</div>
                            <div class="text-xl font-bold text-green-300" id="processTime">-</div>
                        </div>
                        <div class="bg-gray-900 p-4 rounded-lg text-center">
                            <div class="text-gray-400 text-sm mb-1">สถานะ</div>
                            <div class="text-xl font-bold text-blue-300">สำเร็จ</div>
                        </div>
                        <div class="bg-gray-900 p-4 rounded-lg text-center">
                            <div class="text-gray-400 text-sm mb-1">Job ID</div>
                            <div class="text-sm font-bold text-purple-300 truncate" id="resultJobId">-</div>
                        </div>
                    </div>
                    
                    <!-- Video Info -->
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <div class="space-y-2 text-sm">
                            <div class="flex">
                                <div class="text-gray-400 w-24">Prompt:</div>
                                <div class="text-gray-300 flex-1" id="resultPrompt">-</div>
                            </div>
                            <div class="flex">
                                <div class="text-gray-400 w-24">สร้างเมื่อ:</div>
                                <div class="text-gray-300 flex-1" id="createdAt">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- API Response -->
                <div id="apiResponseContainer" class="mb-6 hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-gray-300">API Response</h4>
                        <button 
                            id="copyResponseBtn"
                            class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded transition"
                        >
                            <i class="fas fa-copy mr-1"></i>คัดลอก
                        </button>
                    </div>
                    <div class="bg-gray-900 rounded-lg p-4 max-h-60 overflow-auto">
                        <pre id="apiResponse" class="text-xs text-gray-300 whitespace-pre-wrap"></pre>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="text-center py-16">
                    <div class="text-gray-500 mb-4">
                        <i class="fas fa-film text-6xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-500 mb-2">รอสร้างวิดีโอแรก</h3>
                    <p class="text-gray-600">ป้อนคำอธิบายและกด "สร้างวิดีโอ"</p>
                </div>
                
                <!-- Debug Info -->
                <div id="debugInfo" class="mt-6 text-xs text-gray-500 hidden">
                    <p><i class="fas fa-bug mr-1"></i>Debug: API Response จะแสดงที่นี่</p>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-gray-800 text-center text-gray-500 text-sm">
            <p>GenVDO - สร้างวิดีโอจากข้อความด้วย Grok-Imagine API</p>
            <p class="mt-1">© 2023 - แก้ไขปัญหา API แล้ว</p>
        </footer>
    </div>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // DOM Elements
        const apiKeyInput = document.getElementById('apiKey');
        const apiEndpointInput = document.getElementById('apiEndpoint');
        const promptInput = document.getElementById('prompt');
        const charCountElement = document.getElementById('charCount');
        const aspectRatioSelect = document.getElementById('aspectRatio');
        const modeSelect = document.getElementById('mode');
        const createVideoBtn = document.getElementById('createVideoBtn');
        const testApiBtn = document.getElementById('testApiBtn');
        const simulateBtn = document.getElementById('simulateBtn');
        const toggleApiKeyBtn = document.getElementById('toggleApiKey');
        const copyApiKeyBtn = document.getElementById('copyApiKey');
        const clearPromptBtn = document.getElementById('clearPrompt');
        const copyResponseBtn = document.getElementById('copyResponseBtn');
        
        // Status elements
        const statusContainer = document.getElementById('statusContainer');
        const videoResult = document.getElementById('videoResult');
        const emptyState = document.getElementById('emptyState');
        const apiResponseContainer = document.getElementById('apiResponseContainer');
        const debugInfo = document.getElementById('debugInfo');
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const statusDetail = document.getElementById('statusDetail');
        const timeEstimate = document.getElementById('timeEstimate');
        const statusIcon = document.getElementById('statusIcon');
        
        // Job info elements
        const jobIdElement = document.getElementById('jobId');
        const jobStatusElement = document.getElementById('jobStatus');
        const startTimeElement = document.getElementById('startTime');
        
        // Result elements
        const videoPlayer = document.getElementById('videoPlayer');
        const videoSource = document.getElementById('videoSource');
        const playBtn = document.getElementById('playBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const processTimeElement = document.getElementById('processTime');
        const resultJobIdElement = document.getElementById('resultJobId');
        const resultPromptElement = document.getElementById('resultPrompt');
        const createdAtElement = document.getElementById('createdAt');
        const apiResponseElement = document.getElementById('apiResponse');
        
        // State
        let currentJobId = null;
        let startTime = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        function initApp() {
            // Update character count
            promptInput.addEventListener('input', updateCharCount);
            updateCharCount();
            
            // Toggle API key visibility
            toggleApiKeyBtn.addEventListener('click', function() {
                const type = apiKeyInput.type === 'password' ? 'text' : 'password';
                apiKeyInput.type = type;
                this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });
            
            // Event listeners
            createVideoBtn.addEventListener('click', createVideoJob);
            testApiBtn.addEventListener('click', testApiConnection);
            simulateBtn.addEventListener('click', simulateVideoCreation);
            copyApiKeyBtn.addEventListener('click', copyApiKey);
            clearPromptBtn.addEventListener('click', clearPrompt);
            copyResponseBtn.addEventListener('click', copyApiResponse);
            playBtn.addEventListener('click', toggleVideoPlayback);
            downloadBtn.addEventListener('click', downloadVideo);
            
            // Prompt buttons
            document.querySelectorAll('.prompt-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    promptInput.value = this.dataset.prompt;
                    updateCharCount();
                });
            });
            
            // Video ended event
            videoPlayer.addEventListener('ended', function() {
                playBtn.innerHTML = '<i class="fas fa-play mr-2"></i>เล่น';
            });
            
            // Show debug info in development
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                debugInfo.classList.remove('hidden');
            }
            
            showAlert('GenVDO พร้อมใช้งาน!', 'info');
        }
        
        // Update character count
        function updateCharCount() {
            const count = promptInput.value.length;
            charCountElement.textContent = `${count}/500`;
            charCountElement.className = `text-sm ${count > 500 ? 'text-red-400' : 'text-gray-400'}`;
        }
        
        // Clear prompt
        function clearPrompt() {
            promptInput.value = '';
            updateCharCount();
            promptInput.focus();
        }
        
        // Create video job - FIXED API CALL
        async function createVideoJob() {
            const apiKey = apiKeyInput.value.trim();
            const prompt = promptInput.value.trim();
            const aspectRatio = aspectRatioSelect.value;
            const mode = modeSelect.value;
            
            // Validation
            if (!apiKey) {
                showAlert('กรุณากรอก API Key', 'error');
                apiKeyInput.focus();
                return;
            }
            
            if (!prompt) {
                showAlert('กรุณากรอกคำอธิบายวิดีโอ', 'error');
                promptInput.focus();
                return;
            }
            
            if (prompt.length > 500) {
                showAlert('คำอธิบายยาวเกินไป (สูงสุด 500 ตัวอักษร)', 'error');
                return;
            }
            
            // Update UI
            createVideoBtn.disabled = true;
            createVideoBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังสร้าง...';
            
            // Show status
            statusContainer.classList.remove('hidden');
            videoResult.classList.add('hidden');
            emptyState.classList.add('hidden');
            apiResponseContainer.classList.add('hidden');
            
            // Reset progress
            startTime = new Date();
            updateProgress(10, 'กำลังเตรียมข้อมูล...', 'เตรียมส่งคำขอ API');
            
            try {
                // Create request data according to API documentation
                const requestData = {
                    model: 'grok-imagine/text-to-video',
                    input: {
                        prompt: prompt,
                        aspect_ratio: aspectRatio,
                        mode: mode
                    }
                };
                
                console.log('Sending request data:', requestData);
                
                updateProgress(30, 'กำลังส่งคำขอ...', 'เชื่อมต่อกับ API');
                
                // Send request to API
                const response = await fetch(apiEndpointInput.value, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                updateProgress(60, 'กำลังประมวลผล...', 'รอการตอบกลับจาก API');
                
                // Get response text first to see what we get
                const responseText = await response.text();
                console.log('Raw API response:', responseText);
                
                // Try to parse as JSON
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse JSON:', e);
                    throw new Error(`API returned invalid JSON: ${responseText.substring(0, 100)}...`);
                }
                
                // Log full response for debugging
                console.log('Parsed API response:', result);
                
                // Display API response
                apiResponseElement.textContent = JSON.stringify(result, null, 2);
                apiResponseContainer.classList.remove('hidden');
                
                // Check response structure
                if (!response.ok) {
                    throw new Error(`API Error ${response.status}: ${JSON.stringify(result)}`);
                }
                
                // FIX: Handle different response structures
                // Some APIs return job_id, some return id, some return task_id
                let jobId = null;
                
                if (result.id) {
                    jobId = result.id;
                } else if (result.job_id) {
                    jobId = result.job_id;
                } else if (result.task_id) {
                    jobId = result.task_id;
                } else if (result.jobId) {
                    jobId = result.jobId;
                } else if (result.taskId) {
                    jobId = result.taskId;
                } else if (result.data && result.data.id) {
                    jobId = result.data.id;
                } else if (result.success && result.data) {
                    jobId = result.data;
                }
                
                if (jobId) {
                    currentJobId = jobId;
                    updateProgress(100, 'สร้างงานสำเร็จ!', `Job ID: ${jobId}`, 'success');
                    
                    // Update job info
                    jobIdElement.textContent = jobId;
                    jobStatusElement.textContent = result.status || 'created';
                    startTimeElement.textContent = new Date().toLocaleTimeString('th-TH');
                    
                    // Show processing simulation
                    setTimeout(() => {
                        simulateVideoProcessing(jobId, prompt);
                    }, 2000);
                    
                } else {
                    // If no job ID, check if we have a direct video URL
                    let videoUrl = null;
                    
                    if (result.video_url) {
                        videoUrl = result.video_url;
                    } else if (result.url) {
                        videoUrl = result.url;
                    } else if (result.data && result.data.video_url) {
                        videoUrl = result.data.video_url;
                    }
                    
                    if (videoUrl) {
                        // Direct video URL received
                        updateProgress(100, 'วิดีโอสร้างสำเร็จ!', 'ได้รับวิดีโอโดยตรง', 'success');
                        
                        setTimeout(() => {
                            showVideoResult({
                                jobId: 'direct_' + Date.now(),
                                videoUrl: videoUrl,
                                prompt: prompt,
                                status: 'completed'
                            });
                        }, 1000);
                    } else {
                        // No job ID and no video URL
                        console.warn('No job ID in response, but continuing with simulation');
                        updateProgress(100, 'รับคำตอบแล้ว', 'กำลังประมวลผลวิดีโอ...', 'success');
                        
                        // Generate a fake job ID for simulation
                        currentJobId = 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        jobIdElement.textContent = currentJobId;
                        
                        setTimeout(() => {
                            simulateVideoProcessing(currentJobId, prompt);
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('Create video job error:', error);
                
                // Show detailed error in API response
                apiResponseElement.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                apiResponseContainer.classList.remove('hidden');
                
                // Update progress with error
                updateProgress(0, 'เกิดข้อผิดพลาด', error.message, 'error');
                
                // Offer simulation option
                setTimeout(() => {
                    showAlert('API มีปัญหา ต้องการจำลองผลลัพธ์หรือไม่?', 'warning').then((result) => {
                        if (result.isConfirmed) {
                            simulateVideoCreation();
                        } else {
                            resetUI();
                        }
                    });
                }, 2000);
                
            } finally {
                createVideoBtn.disabled = false;
                createVideoBtn.innerHTML = '<i class="fas fa-play-circle mr-3 text-xl"></i>สร้างวิดีโอ';
            }
        }
        
        // Simulate video processing
        function simulateVideoProcessing(jobId, prompt) {
            statusContainer.classList.add('hidden');
            
            // Show processing steps
            showAlert('กำลังประมวลผลวิดีโอด้วย AI...', 'info');
            
            // Simulate processing time (3-8 seconds)
            const processTime = 3000 + Math.random() * 5000;
            
            setTimeout(() => {
                // Create mock result
                const mockResult = {
                    jobId: jobId,
                    videoUrl: getSampleVideoUrl(prompt),
                    prompt: prompt,
                    status: 'completed',
                    createdAt: new Date().toISOString(),
                    processTime: Math.round(processTime / 1000)
                };
                
                showVideoResult(mockResult);
            }, processTime);
        }
        
        // Show video result
        function showVideoResult(result) {
            videoResult.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // Calculate actual processing time
            const endTime = new Date();
            const actualProcessTime = Math.round((endTime - startTime) / 1000);
            
            // Update result info
            processTimeElement.textContent = `${actualProcessTime} วินาที`;
            resultJobIdElement.textContent = result.jobId;
            resultPromptElement.textContent = result.prompt;
            createdAtElement.textContent = new Date(result.createdAt || endTime).toLocaleString('th-TH');
            
            // Set video source
            videoSource.src = result.videoUrl;
            videoPlayer.load();
            
            // Auto-play video
            setTimeout(() => {
                videoPlayer.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                    playBtn.innerHTML = '<i class="fas fa-play mr-2"></i>เล่น';
                });
                playBtn.innerHTML = '<i class="fas fa-pause mr-2"></i>หยุด';
            }, 500);
            
            showAlert(`วิดีโอสร้างสำเร็จ! ใช้เวลา ${actualProcessTime} วินาที`, 'success');
        }
        
        // Get sample video URL based on prompt
        function getSampleVideoUrl(prompt) {
            const sampleVideos = [
                'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4',
                'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4',
                'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4'
            ];
            
            // Return random sample video
            return sampleVideos[Math.floor(Math.random() * sampleVideos.length)];
        }
        
        // Simulate video creation (demo mode)
        function simulateVideoCreation() {
            const prompt = promptInput.value.trim() || 'A beautiful landscape generated by AI';
            
            if (!prompt) {
                showAlert('กรุณากรอกคำอธิบายวิดีโอ', 'warning');
                return;
            }
            
            // Update UI
            simulateBtn.disabled = true;
            simulateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังจำลอง...';
            
            // Show status
            statusContainer.classList.remove('hidden');
            videoResult.classList.add('hidden');
            emptyState.classList.add('hidden');
            
            // Reset progress
            startTime = new Date();
            updateProgress(10, 'เริ่มจำลอง...', 'เตรียมข้อมูล');
            
            // Generate job ID
            currentJobId = 'sim_job_' + Date.now();
            
            // Simulate API call steps
            const steps = [
                {progress: 30, message: 'ส่งคำขอไปยัง API...'},
                {progress: 50, message: 'รับการตอบกลับ...'},
                {progress: 70, message: 'เริ่มประมวลผลวิดีโอ...'},
                {progress: 90, message: 'สร้างไฟล์วิดีโอ...'},
                {progress: 100, message: 'สำเร็จ!', status: 'success'}
            ];
            
            let stepIndex = 0;
            const stepInterval = setInterval(() => {
                if (stepIndex < steps.length) {
                    const step = steps[stepIndex];
                    updateProgress(step.progress, 'กำลังจำลอง...', step.message, step.status || 'loading');
                    
                    // Update job info
                    if (stepIndex === 1) {
                        jobIdElement.textContent = currentJobId;
                        jobStatusElement.textContent = 'processing';
                        startTimeElement.textContent = new Date().toLocaleTimeString('th-TH');
                    }
                    
                    stepIndex++;
                } else {
                    clearInterval(stepInterval);
                    
                    // Show result after delay
                    setTimeout(() => {
                        const mockResult = {
                            jobId: currentJobId,
                            videoUrl: getSampleVideoUrl(prompt),
                            prompt: prompt,
                            status: 'completed',
                            createdAt: new Date().toISOString(),
                            processTime: Math.round((Date.now() - startTime) / 1000)
                        };
                        
                        // Create mock API response
                        apiResponseElement.textContent = JSON.stringify({
                            success: true,
                            job_id: currentJobId,
                            status: 'completed',
                            message: 'Video generated successfully (simulation mode)',
                            estimated_time: '45 seconds',
                            video_url: mockResult.videoUrl
                        }, null, 2);
                        
                        apiResponseContainer.classList.remove('hidden');
                        showVideoResult(mockResult);
                    }, 1000);
                }
            }, 800);
            
            // Reset button after completion
            setTimeout(() => {
                simulateBtn.disabled = false;
                simulateBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>จำลองผลลัพธ์';
            }, steps.length * 800 + 1000);
        }
        
        // Test API connection
        async function testApiConnection() {
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showAlert('กรุณากรอก API Key', 'error');
                return;
            }
            
            testApiBtn.disabled = true;
            testApiBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังทดสอบ...';
            
            try {
                // Test with a simple request
                const testData = {
                    model: 'grok-imagine/text-to-video',
                    input: {
                        prompt: 'Test connection - please ignore',
                        aspect_ratio: '16:9',
                        mode: 'normal'
                    }
                };
                
                const response = await fetch(apiEndpointInput.value, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                let result;
                
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    result = { raw_response: responseText };
                }
                
                // Display response
                apiResponseElement.textContent = JSON.stringify({
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    response: result
                }, null, 2);
                
                apiResponseContainer.classList.remove('hidden');
                
                if (response.ok) {
                    showAlert(`API Connection Successful! Status: ${response.status}`, 'success');
                } else {
                    showAlert(`API Response: ${response.status} ${response.statusText}`, 'warning');
                }
                
            } catch (error) {
                console.error('API Test Error:', error);
                showAlert(`Connection Error: ${error.message}`, 'error');
                
                // Show error in response area
                apiResponseElement.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
                apiResponseContainer.classList.remove('hidden');
            } finally {
                testApiBtn.disabled = false;
                testApiBtn.innerHTML = '<i class="fas fa-vial mr-2"></i>ทดสอบ API';
            }
        }
        
        // Update progress
        function updateProgress(percent, title, message, status = 'loading') {
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${Math.round(percent)}%`;
            statusTitle.textContent = title;
            statusMessage.textContent = message;
            statusDetail.textContent = message;
            
            // Update icon
            statusIcon.innerHTML = '';
            if (status === 'loading') {
                statusIcon.innerHTML = '<i class="fas fa-sync-alt rotate text-blue-400"></i>';
                timeEstimate.textContent = 'ประมาณ 60 วินาที';
            } else if (status === 'success') {
                statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-400"></i>';
                timeEstimate.textContent = 'สำเร็จ';
            } else if (status === 'error') {
                statusIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-400"></i>';
                timeEstimate.textContent = 'ผิดพลาด';
            }
        }
        
        // Reset UI
        function resetUI() {
            statusContainer.classList.add('hidden');
            createVideoBtn.disabled = false;
            createVideoBtn.innerHTML = '<i class="fas fa-play-circle mr-3 text-xl"></i>สร้างวิดีโอ';
        }
        
        // Copy API Key
        function copyApiKey() {
            navigator.clipboard.writeText(apiKeyInput.value).then(() => {
                showAlert('คัดลอก API Key เรียบร้อยแล้ว', 'success');
            });
        }
        
        // Copy API Response
        function copyApiResponse() {
            navigator.clipboard.writeText(apiResponseElement.textContent).then(() => {
                showAlert('คัดลอก API Response เรียบร้อยแล้ว', 'success');
            });
        }
        
        // Toggle video playback
        function toggleVideoPlayback() {
            if (videoPlayer.paused) {
                videoPlayer.play();
                playBtn.innerHTML = '<i class="fas fa-pause mr-2"></i>หยุด';
            } else {
                videoPlayer.pause();
                playBtn.innerHTML = '<i class="fas fa-play mr-2"></i>เล่น';
            }
        }
        
        // Download video
        function downloadVideo() {
            if (!videoSource.src) {
                showAlert('ไม่มีวิดีโอให้ดาวน์โหลด', 'warning');
                return;
            }
            
            const link = document.createElement('a');
            link.href = videoSource.src;
            link.download = `genvdo_${currentJobId || Date.now()}.mp4`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('เริ่มดาวน์โหลดวิดีโอแล้ว', 'success');
        }
        
        // Show alert with promise return
        function showAlert(message, type = 'info') {
            return Swal.fire({
                icon: type,
                title: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                background: '#1f2937',
                color: '#f9fafb'
            });
        }
    </script>
</body>
</html>
